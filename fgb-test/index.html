<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoning Districts Map Visualization</title>
    
    <!-- Load Mapbox GL JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/2.15.0/mapbox-gl.css" rel="stylesheet">
    
    <!-- Load FlatGeoBuf -->
    <script src="https://unpkg.com/flatgeobuf@3.22.0/dist/flatgeobuf-geojson.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        #progress {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
        .legend {
            background-color: white;
            border-radius: 3px;
            bottom: 30px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            padding: 10px;
            position: absolute;
            right: 10px;
            z-index: 1;
            max-height: 400px;
            overflow-y: auto;
        }
        .legend h4 {
            margin: 0 0 10px;
        }
        .legend div {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend span {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading">Loading data...</div>
    <div id="progress"></div>
    <div id="legend" class="legend">
        <h4>Zoning Districts</h4>
    </div>

    <script>
        // Initialize the map
        mapboxgl.accessToken = 'pk.eyJ1IjoiYmRjb29sZXkiLCJhIjoiY20zM2Nzd212MWl3cTJrcTM5NWNrcjk0byJ9.40rHMMd1TXsvF8zeqxLaBw';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [-74.5, 40],
            zoom: 9
        });

        const loadingElement = document.getElementById('loading');
        const progressElement = document.getElementById('progress');
        const legendElement = document.getElementById('legend');
        let featuresLoaded = 0;
        let source = null;

        // Color palette for zoning districts
        const colors = [
            '#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', 
            '#ffff33', '#a65628', '#f781bf', '#999999', '#66c2a5',
            '#fc8d62', '#8da0cb', '#e78ac3', '#a6d854', '#ffd92f',
            '#e5c494', '#b3b3b3', '#7fc97f', '#beaed4', '#fdc086'
        ];

        // Store unique zoning types and their colors
        const zoningColors = new Map();
        let colorIndex = 0;

        // Function to get or assign color for zoning type
        function getZoningColor(zoningType) {
            if (!zoningColors.has(zoningType)) {
                zoningColors.set(zoningType, colors[colorIndex % colors.length]);
                colorIndex++;
                updateLegend();
            }
            return zoningColors.get(zoningType);
        }

        // Function to update the legend
        function updateLegend() {
            const legendContent = document.createElement('div');
            Array.from(zoningColors.entries())
                .sort((a, b) => a[0].localeCompare(b[0]))
                .forEach(([type, color]) => {
                    const item = document.createElement('div');
                    item.innerHTML = `<span style="background-color: ${color}"></span>${type}`;
                    legendContent.appendChild(item);
                });
            
            // Clear existing legend items (keeping the header)
            while (legendElement.childNodes.length > 2) {
                legendElement.removeChild(legendElement.lastChild);
            }
            legendElement.appendChild(legendContent);
        }

        // Function to update progress
        function updateProgress(loaded) {
            featuresLoaded = loaded;
            progressElement.textContent = `Loaded ${loaded} features`;
        }

        map.on('load', async () => {
            try {
                loadingElement.style.display = 'block';
                progressElement.style.display = 'block';
                console.log('Starting to load FlatGeoBuf data...');

                // Initialize an empty GeoJSON source
                map.addSource('fgb-data', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: []
                    }
                });

                // Add the visualization layer with initial default color
                map.addLayer({
                    id: 'fgb-layer',
                    type: 'fill',
                    source: 'fgb-data',
                    paint: {
                        'fill-color': '#ccc',  // Start with default color
                        'fill-opacity': 0.7,
                        'fill-outline-color': '#000'
                    }
                });

                // Get the source reference
                source = map.getSource('fgb-data');

                // Create a feature collection to store loaded features
                let features = [];
                
                // Start streaming features from the FGB file
                const response = await fetch('../data/vt-zoning-spatial-index.fgb');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                // Use FlatGeoBuf streaming API
                for await (const feature of flatgeobuf.deserialize(response.body)) {
                    // Assign color based on zoning type
                    const zoningType = feature.properties.Type_of_Zoning_District || 'Unknown';
                    getZoningColor(zoningType);
                    
                    features.push(feature);
                    featuresLoaded++;
                    
                    // Update the map every 100 features
                    if (featuresLoaded % 100 === 0) {
                        updateProgress(featuresLoaded);
                        source.setData({
                            type: 'FeatureCollection',
                            features: features
                        });
                        
                        // Update layer style to include new colors
                        if (zoningColors.size > 0) {
                            const matchExpression = ['match', ['get', 'Type_of_Zoning_District']];
                            
                            // Add each zoning type and its color to the match expression
                            for (const [type, color] of zoningColors) {
                                matchExpression.push(type);
                                matchExpression.push(color);
                            }
                            
                            // Add the default color at the end
                            matchExpression.push('#ccc');
                            
                            map.setPaintProperty('fgb-layer', 'fill-color', matchExpression);
                        }
                    }
                }

                // Final update with all features
                source.setData({
                    type: 'FeatureCollection',
                    features: features
                });

                // Fit map to data bounds
                const bounds = new mapboxgl.LngLatBounds();
                features.forEach(feature => {
                    if (feature.geometry) {
                        const coords = feature.geometry.coordinates;
                        if (feature.geometry.type === 'Polygon') {
                            coords[0].forEach(coord => bounds.extend(coord));
                        } else if (feature.geometry.type === 'Point') {
                            bounds.extend(coords);
                        }
                    }
                });
                map.fitBounds(bounds, { padding: 50 });

                console.log('Map visualization complete');

            } catch (error) {
                console.error('Error loading FlatGeoBuf data:', error);
                loadingElement.textContent = 'Error loading data';
            } finally {
                loadingElement.style.display = 'none';
                progressElement.style.display = 'none';
            }
        });

        // Add interaction
        map.on('click', 'fgb-layer', (e) => {
            if (!e.features.length) return;

            const feature = e.features[0];
            const coordinates = e.lngLat;

            const properties = Object.entries(feature.properties)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(properties)
                .addTo(map);
        });

        // Change cursor on hover
        map.on('mouseenter', 'fgb-layer', () => {
            map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', 'fgb-layer', () => {
            map.getCanvas().style.cursor = '';
        });
    </script>
</body>
</html>